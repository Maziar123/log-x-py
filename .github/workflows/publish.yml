name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'     # Trigger on version tags (e.g., v1.0.0, v1.1.0)
      - '[0-9]*' # Trigger on numeric tags (e.g., 0.4.0, 1.0.0)
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  id-token: write  # REQUIRED for Trusted Publishing

jobs:
  build-and-publish-all:
    name: Build and publish all packages to PyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for versioneer to detect tags

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine hatchling
          python -m pip install versioneer

      # ============================================================================
      # Build logxpy (uses setuptools + versioneer) - Use API token
      # ============================================================================
      - name: Build logxpy
        working-directory: ./logxpy
        run: |
          python -m build

      - name: Store logxpy distributions
        uses: actions/upload-artifact@v4
        with:
          name: logxpy-distributions
          path: logxpy/dist/

      - name: Publish logxpy to PyPI (using API token)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: logxpy/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}

      # ============================================================================
      # Build logxpy-cli-view (new package) - Use API token for first publish
      # ============================================================================
      - name: Build logxpy-cli-view
        working-directory: ./logxpy_cli_view
        run: |
          python -m build

      - name: Store logxpy-cli-view distributions
        uses: actions/upload-artifact@v4
        with:
          name: logxpy-cli-view-distributions
          path: logxpy_cli_view/dist/

      - name: Publish logxpy-cli-view to PyPI (using API token for new package)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: logxpy_cli_view/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      # ============================================================================
      # Build logxy-log-parser (new package) - Use API token for first publish
      # ============================================================================
      - name: Build logxy-log-parser
        working-directory: ./logxy-log-parser
        run: |
          python -m build

      - name: Store logxy-log-parser distributions
        uses: actions/upload-artifact@v4
        with:
          name: logxy-log-parser-distributions
          path: logxy-log-parser/dist/

      - name: Publish logxy-log-parser to PyPI (using API token for new package)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: logxy-log-parser/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

  # Separate job to verify packages after publishing
  verify:
    name: Verify packages on PyPI
    runs-on: ubuntu-latest
    needs: build-and-publish-all
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install packages from PyPI
        run: |
          python -m pip install --upgrade pip
          echo "Installing logxpy..."
          pip install logxpy || echo "logxpy not yet available or install failed"
          echo "Installing logxpy-cli-view..."
          pip install logxpy-cli-view || echo "logxpy-cli-view not yet available or install failed"
          echo "Installing logxy-log-parser..."
          pip install logxy-log-parser || echo "logxy-log-parser not yet available or install failed"

      - name: Verify installations
        run: |
          echo "Checking installed packages..."
          pip list | grep -i logxpy || true
          pip list | grep -i logxy || true

          # Check if logxpy-cli-view command is available
          if command -v logxpy-cli-view &> /dev/null; then
              echo "✓ logxpy-cli-view command available"
              logxpy-cli-view --help || true
          else
              echo "✗ logxpy-cli-view command not found (alias may be needed)"
          fi

          # Check if logxy commands are available
          if command -v logxy-query &> /dev/null; then
              echo "✓ logxy-query command available"
          else
              echo "✗ logxy-query command not found"
          fi
